<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processador Avançado de Áudio | Labor AI</title>
    
    <!-- Habilitar Cross-Origin Isolation para FFmpeg.wasm -->
    <meta name="Cross-Origin-Opener-Policy" content="same-origin">
    <meta name="Cross-Origin-Embedder-Policy" content="require-corp">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Fira+Code&display=swap" rel="stylesheet">
    
    <!-- FFmpeg.wasm - Carregado de forma assíncrona -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.min.js" defer></script>
    <script src="https://unpkg.com/@ffmpeg/util@0.12.1/dist/umd/util.min.js" defer></script>
    
    <style>
        :root {
            --primary-color: #0d9488;
            --primary-hover: #0f766e;
            --background-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border-color: #d1d5db;
            --success-color: #16a34a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background-color: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            width: 100%;
            max-width: 800px;
            text-align: center;
            padding: 40px;
        }

        .header h1 { font-size: 32px; font-weight: 700; }
        .header p { font-size: 18px; color: var(--text-secondary); margin-top: 8px; margin-bottom: 32px; }

        #drop-area { border: 2px dashed var(--border-color); border-radius: 12px; padding: 48px; cursor: pointer; transition: all 0.2s ease; }
        #drop-area:hover, #drop-area.dragover { border-color: var(--primary-color); background-color: #f0fdfa; }

        #files-list-container { margin-top: 24px; text-align: left; }
        #files-list { list-style: none; }
        .file-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background-color: #f9fafb; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 8px; cursor: grab; }
        .file-item:active { cursor: grabbing; background-color: #f0fdfa; }
        .remove-file-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 20px; }

        .task-options { margin-top: 24px; text-align: left; }
        .task-option label { margin-left: 8px; }

        #process-button { width: 100%; padding: 16px; margin-top: 24px; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; }
        #process-button:disabled { background-color: #a5b0b8; cursor: not-allowed; }

        #processing-stage .spinner { width: 48px; height: 48px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 24px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #result-stage { text-align: left; }
        .tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 24px; }
        .tab { padding: 12px 20px; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab.active { border-bottom-color: var(--primary-color); color: var(--primary-color); font-weight: 700; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        #result-text { width: 100%; height: 350px; padding: 16px; border: 1px solid var(--border-color); border-radius: 8px; font-family: 'Fira Code', monospace; line-height: 1.7; resize: vertical; }
        .result-actions { margin-top: 16px; display: flex; gap: 16px; }
        
        .footer { margin-top: 40px; font-size: 14px; color: var(--text-secondary); }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <header class="header">
            <h1>Processador Avançado de Áudio</h1>
            <p>Una, comprima e extraia insights com a IA da Labor AI.</p>
        </header>

        <!-- ETAPA 1: UPLOAD E CONFIGURAÇÃO -->
        <div id="setup-stage">
            <input type="file" id="file-input" class="hidden" accept="audio/*" multiple>
            <div id="drop-area">
                <p>Arraste e solte seus áudios aqui ou clique para selecionar</p>
                <small>Selecione múltiplos arquivos para uni-los automaticamente</small>
            </div>
            
            <div id="files-list-container" class="hidden">
                <h4>Arquivos para Processar (arraste para reordenar):</h4>
                <ul id="files-list"></ul>
            </div>

            <div id="task-options" class="task-options hidden">
                <h4>Ações Desejadas:</h4>
                <div class="task-option">
                    <input type="checkbox" id="task-transcribe" name="tasks" value="transcribe" checked>
                    <label for="task-transcribe">Transcrição Completa</label>
                </div>
                <div class="task-option">
                    <input type="checkbox" id="task-bullets" name="tasks" value="bullets">
                    <label for="task-bullets">Gerar Pontos Chave (Bullet Points)</label>
                </div>
                <div class="task-option">
                    <input type="checkbox" id="task-summary" name="tasks" value="summary">
                    <label for="task-summary">Criar Resumo Executivo</label>
                </div>
            </div>

            <button id="process-button" disabled>Carregando motor de áudio...</button>
        </div>

        <!-- ETAPA 2: PROCESSANDO -->
        <div id="processing-stage" class="hidden">
            <div class="spinner"></div>
            <p id="status-text">Iniciando...</p>
        </div>

        <!-- ETAPA 3: RESULTADO -->
        <div id="result-stage" class="hidden">
            <h3>Resultados do Processamento</h3>
            <div class="tabs" id="result-tabs"></div>
            <div id="result-contents"></div>
            <div class="result-actions">
                <button id="reset-button">Processar Outro</button>
            </div>
        </div>
    </div>

    <footer class="footer">Desenvolvido pela Labor AI</footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Configurações
            const webhookUrl = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/a7afa173-d939-46f8-80d7-0e2a9845c928';

            // Elementos DOM
            const setupStage = document.getElementById('setup-stage');
            const processingStage = document.getElementById('processing-stage');
            const resultStage = document.getElementById('result-stage');
            const dropArea = document.getElementById('drop-area');
            const fileInput = document.getElementById('file-input');
            const filesListContainer = document.getElementById('files-list-container');
            const filesList = document.getElementById('files-list');
            const taskOptions = document.getElementById('task-options');
            const processButton = document.getElementById('process-button');
            const statusText = document.getElementById('status-text');
            const resultTabs = document.getElementById('result-tabs');
            const resultContents = document.getElementById('result-contents');
            const resetButton = document.getElementById('reset-button');
            
            // Estado da Aplicação
            let ffmpeg;
            let ffmpegLoaded = false;
            let selectedFiles = [];
            
            // Carregar FFmpeg de forma segura
            async function loadFFmpeg() {
                try {
                    if (typeof FFmpegWASM === 'undefined') {
                        setTimeout(loadFFmpeg, 100);
                        return;
                    }
                    const { FFmpeg } = FFmpegWASM;
                    ffmpeg = new FFmpeg();
                    await ffmpeg.load({ coreURL: "https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.js" });
                    ffmpegLoaded = true;
                    processButton.disabled = true;
                    processButton.textContent = 'Selecione um ou mais arquivos';
                } catch (e) {
                    processButton.textContent = 'Erro ao carregar motor de áudio';
                    console.error("FFmpeg load error:", e);
                }
            }
            loadFFmpeg();

            // Lógica de Upload
            dropArea.addEventListener('click', () => fileInput.click());
            dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.classList.add('dragover'); });
            dropArea.addEventListener('dragleave', () => dropArea.classList.remove('dragover'));
            dropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dropArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });
            fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

            function handleFiles(files) {
                selectedFiles = Array.from(files);
                renderFilesList();
                validateForm();
            }

            function renderFilesList() {
                filesList.innerHTML = '';
                if (selectedFiles.length > 0) {
                    selectedFiles.forEach((file, index) => {
                        const li = document.createElement('li');
                        li.className = 'file-item';
                        li.dataset.index = index;
                        li.draggable = true;
                        li.innerHTML = `<span>${file.name}</span><button class="remove-file-btn" data-index="${index}">×</button>`;
                        filesList.appendChild(li);
                    });
                    filesListContainer.classList.remove('hidden');
                    taskOptions.classList.remove('hidden');
                } else {
                    filesListContainer.classList.add('hidden');
                    taskOptions.classList.add('hidden');
                }
            }
            
            // Lógica de Reordenar (Drag and Drop)
            let dragStartIndex;
            filesList.addEventListener('dragstart', (e) => {
                dragStartIndex = +e.target.dataset.index;
            });
            filesList.addEventListener('dragover', (e) => e.preventDefault());
            filesList.addEventListener('drop', (e) => {
                const dragEndIndex = +e.target.closest('li').dataset.index;
                const [draggedItem] = selectedFiles.splice(dragStartIndex, 1);
                selectedFiles.splice(dragEndIndex, 0, draggedItem);
                renderFilesList();
            });
            
            filesList.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-file-btn')) {
                    const index = +e.target.dataset.index;
                    selectedFiles.splice(index, 1);
                    renderFilesList();
                    validateForm();
                }
            });

            function validateForm() {
                processButton.disabled = !(ffmpegLoaded && selectedFiles.length > 0);
            }
            
            // Processamento Principal
            processButton.addEventListener('click', async () => {
                setupStage.classList.add('hidden');
                processingStage.classList.remove('hidden');
                
                try {
                    const { fetchFile } = FFmpegUtil;
                    let fileToProcess;

                    if (selectedFiles.length > 1) {
                        statusText.textContent = `Unindo ${selectedFiles.length} arquivos...`;
                        const fileNames = [];
                        for (let i = 0; i < selectedFiles.length; i++) {
                            const name = `input${i}`;
                            await ffmpeg.writeFile(name, await fetchFile(selectedFiles[i]));
                            fileNames.push(`file '${name}'`);
                        }
                        await ffmpeg.writeFile('list.txt', fileNames.join('\n'));
                        await ffmpeg.exec(['-f', 'concat', '-safe', '0', '-i', 'list.txt', 'merged.mp3']);
                        fileToProcess = await ffmpeg.readFile('merged.mp3');
                    } else {
                        fileToProcess = await fetchFile(selectedFiles[0]);
                    }

                    statusText.textContent = 'Comprimindo áudio...';
                    await ffmpeg.writeFile('input.file', fileToProcess);
                    await ffmpeg.exec(['-i', 'input.file', '-b:a', '64k', '-vn', '-ar', '16000', 'output.mp3']);
                    const finalAudioData = await ffmpeg.readFile('output.mp3');
                    const finalAudioFile = new File([finalAudioData], 'processed_audio.mp3', { type: 'audio/mpeg' });

                    statusText.textContent = 'Enviando para a IA da Labor AI...';
                    const selectedTasks = Array.from(document.querySelectorAll('input[name="tasks"]:checked')).map(cb => cb.value);
                    
                    const formData = new FormData();
                    formData.append('audio', finalAudioFile);
                    formData.append('tasks', JSON.stringify(selectedTasks));

                    const response = await fetch(webhookUrl, { method: 'POST', body: formData });
                    if (!response.ok) throw new Error('Falha na comunicação com o servidor.');

                    const results = await response.json();
                    displayResults(results);

                } catch (error) {
                    console.error(error);
                    statusText.textContent = `Erro: ${error.message}`;
                }
            });
            
            function displayResults(results) {
                processingStage.classList.add('hidden');
                resultStage.classList.remove('hidden');
                resultTabs.innerHTML = '';
                resultContents.innerHTML = '';

                Object.keys(results).forEach((key, index) => {
                    const tab = document.createElement('div');
                    tab.className = 'tab' + (index === 0 ? ' active' : '');
                    tab.textContent = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    tab.dataset.tab = key;
                    resultTabs.appendChild(tab);

                    const content = document.createElement('div');
                    content.className = 'tab-content' + (index === 0 ? ' active' : '');
                    content.id = `content-${key}`;
                    const textArea = document.createElement('textarea');
                    textArea.className = 'result-text';
                    textArea.readOnly = true;
                    textArea.value = results[key];
                    content.appendChild(textArea);
                    resultContents.appendChild(content);
                });

                resultTabs.addEventListener('click', (e) => {
                    if(e.target.classList.contains('tab')) {
                        const tabKey = e.target.dataset.tab;
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        e.target.classList.add('active');
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        document.getElementById(`content-${tabKey}`).classList.add('active');
                    }
                });
            }

            resetButton.addEventListener('click', () => {
                selectedFiles = [];
                renderFilesList();
                validateForm();
                resultStage.classList.add('hidden');
                setupStage.classList.remove('hidden');
            });

        });
    </script>
</body>
</html>
